{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- En-tête de l'article -->
    <div class="max-w-4xl mx-auto">
        <div class="mb-8">
            <a href="{{ url_for('blog') }}" class="text-blue-600 hover:text-blue-800">
                <i class="fas fa-arrow-left"></i> Retour au blog
            </a>
        </div>

        <article class="bg-white rounded-lg shadow-lg overflow-hidden">
            {% if post.image_url %}
            <img src="{{ post.image_url }}" alt="{{ post.title }}" class="w-full h-64 object-cover">
            {% endif %}
            
            <div class="p-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>
                
                <div class="flex items-center text-gray-600 text-sm mb-8">
                    <span class="mr-4">Par {{ post.author_name }}</span>
                    <span class="mr-4">{{ post.created_at }}</span>
                    <span class="mr-4">
                        <i class="fas fa-heart {% if post.liked %}text-red-500{% endif %}"></i> {{ post.likes }}
                    </span>
                    <span>
                        <i class="fas fa-comment"></i> {{ post.comments|length }}
                    </span>
                </div>

                {% if post.tags %}
                <div class="flex flex-wrap gap-2 mb-8">
                    {% for tag in post.tags %}
                    <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full">
                        {{ tag }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="prose max-w-none">
                    {{ post.content|safe }}
                </div>

                {% if is_authenticated and post.author_id == session.user_id %}
                <div class="mt-8 flex gap-4">
                    <a href="{{ url_for('edit_post', post_id=post._id) }}"
                       class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        Modifier
                    </a>
                    <button onclick="deletePost('{{ post._id }}')"
                            class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                        Supprimer
                    </button>
                </div>
                {% endif %}
            </div>
        </article>

        <!-- Section commentaires -->
        <div class="mt-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Commentaires</h2>

            {% if is_authenticated %}
            <div class="mb-8">
                <textarea id="commentContent"
                          class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          rows="3"
                          placeholder="Ajouter un commentaire..."></textarea>
                <button onclick="addComment('{{ post._id }}')"
                        class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                    Publier
                </button>
            </div>
            {% else %}
            <p class="text-gray-600 mb-8">
                <a href="{{ url_for('login') }}" class="text-blue-600 hover:text-blue-800">Connectez-vous</a>
                pour laisser un commentaire.
            </p>
            {% endif %}

            <div id="comments" class="space-y-6">
                {% for comment in post.comments|reverse %}
                <div class="bg-gray-50 p-6 rounded-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-semibold text-gray-900">{{ comment.user_name }}</h3>
                            <p class="text-sm text-gray-600">{{ comment.created_at }}</p>
                        </div>
                    </div>
                    <p class="text-gray-800">{{ comment.content }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function deletePost(postId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer cet article ?')) return;
    
    fetch(`/blog/delete/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{{ url_for("blog") }}';
        } else {
            alert('Erreur lors de la suppression de l\'article');
        }
    });
}

function addComment(postId) {
    const content = document.getElementById('commentContent').value;
    if (!content.trim()) return;
    
    fetch(`/blog/comment/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur lors de l\'ajout du commentaire');
        }
    });
}

function toggleLike(postId) {
    fetch(`/blog/like/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
</script>
{% endblock %} 